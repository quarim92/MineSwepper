<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minesweeper Worlds</title>
    <!-- Telegram WebApp SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --tg-theme-bg-color: #0f172a;
            --tg-theme-button-color: #3b82f6;
            --tg-theme-button-text-color: #ffffff;
            --accent: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color, white);
            transition: all 0.5s ease;
            overflow: hidden;
            touch-action: manipulation;
        }

        .cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.1s;
            user-select: none;
            border-radius: 8px;
            font-size: 1.1rem;
        }

        .cell-hidden {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.05);
        }

        .cell-revealed {
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .cell-mine {
            background: #ef4444 !important;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
        }

        /* –¶–≤–µ—Ç–∞ –¥–ª—è —Ü–∏—Ñ—Ä */
        .num-1 { color: #3b82f6; }
        .num-2 { color: #10b981; }
        .num-3 { color: #ef4444; }
        .num-4 { color: #a855f7; }
        .num-5 { color: #f59e0b; }
        .num-6 { color: #06b6d4; }
        .num-7 { color: #ec4899; }
        .num-8 { color: #ffffff; text-shadow: 0 0 5px rgba(255,255,255,0.5); }

        /* –ö–∞—Å—Ç–æ–º–Ω–æ–µ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
        .nav-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            height: 70px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: space-around;
            z-index: 1000;
            padding: 0 10px;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0.4;
            height: 100%;
            border-radius: 16px;
        }

        .nav-item.active {
            opacity: 1;
            background: rgba(255, 255, 255, 0.05);
            color: var(--accent);
        }

        .nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }

        .nav-item span {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tg-button {
            background-color: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <div class="p-4 flex justify-between items-center bg-black/10 backdrop-blur-md sticky top-0 z-50">
        <div id="user-info" class="flex items-center space-x-3">
            <div id="user-photo" class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center font-bold text-sm bg-cover">?</div>
            <div>
                <div id="user-name" class="text-sm font-bold">Player</div>
                <div class="text-[10px] opacity-50 uppercase font-black" id="user-status">–ù–æ–≤–∏—á–æ–∫</div>
            </div>
        </div>
        <div class="text-right">
            <div class="text-[9px] opacity-40 uppercase font-black">–ë–∞–ª–∞–Ω—Å</div>
            <div class="text-lg font-black text-yellow-500"><span id="balance">0</span> ü™ô</div>
        </div>
    </div>

    <!-- Location Banner -->
    <div class="px-4 py-2">
        <div id="loc-banner" class="p-3 rounded-2xl text-center text-[10px] font-black uppercase tracking-[0.2em] border transition-all shadow-lg">
            üå≤ –¢–ò–•–ò–ô –õ–ï–°
        </div>
    </div>

    <!-- Game Board -->
    <div class="flex-1 flex flex-col items-center justify-center p-4 pb-32">
        <div id="grid-container" class="p-3 rounded-3xl bg-white/5 border border-white/10 shadow-2xl relative">
            <div id="grid" class="grid gap-2">
                <!-- Cells -->
            </div>
        </div>

        <div class="mt-8 flex items-center justify-between w-full max-w-[280px]">
            <div class="flex flex-col items-center">
                <button id="flag-mode-btn" class="w-14 h-14 rounded-2xl bg-white/5 flex items-center justify-center text-xl transition-all border border-white/10 active:scale-90">
                    üö©
                </button>
                <div id="mine-count" class="mt-2 text-[9px] font-black opacity-40 uppercase">10 –æ—Å—Ç–∞—Ç–æ–∫</div>
            </div>
            
            <button id="refresh-btn" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center opacity-30 active:rotate-180 transition-all">üîÑ</button>
            
            <div class="flex flex-col items-center">
                <button onclick="shareProgress()" class="w-14 h-14 rounded-2xl bg-white/5 flex items-center justify-center text-xl transition-all border border-white/10 active:scale-90">
                    üì¢
                </button>
                <div class="mt-2 text-[9px] font-black opacity-40 uppercase">–ò–Ω—Ñ–æ</div>
            </div>
        </div>
    </div>

    <!-- Bottom Nav -->
    <nav class="nav-container">
        <button onclick="switchTab('game')" id="tab-game" class="nav-item active">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z" />
            </svg>
            <span>–ò–≥—Ä–∞</span>
        </button>
        <button onclick="switchTab('profile')" id="tab-profile" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
        <button onclick="tg.showAlert('–†–µ–π—Ç–∏–Ω–≥ —Å–∫–æ—Ä–æ –ø–æ—è–≤–∏—Ç—Å—è!')" class="nav-item">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
            </svg>
            <span>–¢–æ–ø</span>
        </button>
    </nav>

    <!-- Profile View -->
    <div id="profile-view" class="fixed inset-0 z-[1001] bg-slate-950 hidden flex flex-col pt-10 px-6">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black italic uppercase tracking-widest">Profile</h2>
            <button onclick="switchTab('game')" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center text-2xl">&times;</button>
        </div>
        
        <div class="bg-white/5 rounded-[32px] p-8 border border-white/10 flex flex-col items-center text-center">
            <div id="profile-avatar" class="w-24 h-24 rounded-full bg-gradient-to-tr from-blue-500 to-emerald-500 mb-6 flex items-center justify-center text-4xl shadow-2xl bg-cover"></div>
            <div id="profile-name" class="text-2xl font-black mb-2">...</div>
            <div id="profile-status-badge" class="px-4 py-1.5 bg-blue-500 text-white text-[10px] font-black uppercase rounded-full shadow-lg shadow-blue-500/30">–ù–æ–≤–∏—á–æ–∫</div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-8">
            <div class="bg-white/5 p-6 rounded-3xl border border-white/5">
                <div class="text-[10px] opacity-30 font-black uppercase mb-1">–ö–æ–∏–Ω—ã</div>
                <div id="stat-coins" class="text-2xl font-black">0</div>
            </div>
            <div class="bg-white/5 p-6 rounded-3xl border border-white/5">
                <div class="text-[10px] opacity-30 font-black uppercase mb-1">–°–µ–∫—Ç–æ—Ä–∞</div>
                <div id="stat-worlds" class="text-2xl font-black">0</div>
            </div>
        </div>
        
        <button onclick="shareProgress()" class="mt-10 tg-button w-full py-5 rounded-3xl font-black text-sm uppercase tracking-widest shadow-xl active:scale-95 transition-all">
            –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
        </button>
    </div>

    <!-- Win/Loss Modal -->
    <div id="game-modal" class="modal-overlay fixed inset-0 z-[2000] hidden flex items-center justify-center p-8">
        <div class="bg-[#1e293b] w-full max-w-xs rounded-[40px] p-10 text-center border border-white/10 shadow-2xl">
            <div id="modal-icon" class="text-8xl mb-6">üèÜ</div>
            <h2 id="modal-title" class="text-3xl font-black mb-2 uppercase italic tracking-tighter">Win</h2>
            <p id="modal-text" class="text-slate-400 text-sm mb-10 font-bold opacity-70">–°–µ–∫—Ç–æ—Ä –∑–∞—á–∏—â–µ–Ω!</p>
            <button id="modal-btn" class="tg-button w-full py-5 rounded-2xl font-black text-sm uppercase tracking-widest shadow-lg">
                –î–∞–ª–µ–µ
            </button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        const BIOMES = [
            { name: "–¢–∏—Ö–∏–π –õ–µ—Å", emoji: "üå≤", mine: "üçÑ", bg: "#064e3b", accent: "#10b981" },
            { name: "–ó–æ–ª–æ—Ç–∞—è –ü—É—Å—Ç—ã–Ω—è", emoji: "üèúÔ∏è", mine: "ü¶Ç", bg: "#422006", accent: "#fbbf24" },
            { name: "–õ–µ–¥—è–Ω–æ–π –ì—Ä–æ—Ç", emoji: "‚ùÑÔ∏è", mine: "üßä", bg: "#0c4a6e", accent: "#38bdf8" },
            { name: "–ó–∞–±—ã—Ç–∞—è –®–∞—Ö—Ç–∞", emoji: "‚öíÔ∏è", mine: "üß®", bg: "#451a03", accent: "#f97316" },
            { name: "–ö—Ä–æ–≤–∞–≤—ã–π –†–∏—Ñ—Ç", emoji: "üåò", mine: "üåã", bg: "#450a0a", accent: "#ef4444" },
            { name: "–ù–µ–æ–Ω–æ–≤—ã–π –°–∏—Ç–∏", emoji: "üåÉ", mine: "üëæ", bg: "#2e1065", accent: "#a855f7" },
            { name: "–ú–µ—Ä—Ç–≤—ã–π –ö–æ—Å–º–æ—Å", emoji: "ü™ê", mine: "‚òÑÔ∏è", bg: "#111827", accent: "#6366f1" },
            { name: "–Ø–¥—Ä–æ –ü–ª–∞–Ω–µ—Ç—ã", emoji: "‚ò¢Ô∏è", mine: "üî•", bg: "#1e1b4b", accent: "#f43f5e" }
        ];

        let state = {
            level: 1,
            balance: 0,
            worldsCleared: 0,
            rows: 7,
            cols: 7,
            mineCount: 8,
            mines: [],
            revealed: new Set(),
            flags: new Set(),
            firstClick: true,
            gameOver: false,
            isFlagMode: false
        };

        function setupTelegramUI() {
            const user = tg.initDataUnsafe?.user;
            if (user) {
                document.getElementById('user-name').textContent = user.first_name;
                document.getElementById('profile-name').textContent = `${user.first_name} ${user.last_name || ''}`;
                document.getElementById('user-photo').textContent = user.first_name[0];
                document.getElementById('profile-avatar').textContent = user.first_name[0];
                if (user.photo_url) {
                    document.getElementById('user-photo').style.backgroundImage = `url(${user.photo_url})`;
                    document.getElementById('profile-avatar').style.backgroundImage = `url(${user.photo_url})`;
                    document.getElementById('user-photo').textContent = '';
                    document.getElementById('profile-avatar').textContent = '';
                }
            }
            document.documentElement.style.setProperty('--accent', tg.buttonColor || '#3b82f6');
        }

        function updateTheme() {
            const biome = BIOMES[(state.level - 1) % BIOMES.length];
            document.body.style.backgroundColor = biome.bg;
            
            const banner = document.getElementById('loc-banner');
            banner.innerHTML = `${biome.emoji} ${biome.name}`;
            banner.style.borderColor = `${biome.accent}44`;
            banner.style.color = biome.accent;
            banner.style.backgroundColor = `${biome.bg}cc`;
            banner.style.boxShadow = `0 10px 30px ${biome.bg}`;
        }

        function initGame() {
            state.gameOver = false;
            state.firstClick = true;
            state.revealed.clear();
            state.flags.clear();
            
            state.rows = Math.min(10, 6 + Math.floor(state.level / 4));
            state.cols = state.rows;
            const density = 0.16 + (state.level * 0.01);
            state.mineCount = Math.floor(state.rows * state.cols * Math.min(0.26, density));

            updateTheme();
            createGrid();
            updateUI();
        }

        function createGrid() {
            const gridEl = document.getElementById('grid');
            gridEl.innerHTML = '';
            gridEl.style.gridTemplateColumns = `repeat(${state.cols}, 1fr)`;
            
            for (let r = 0; r < state.rows; r++) {
                for (let c = 0; c < state.cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell cell-hidden';
                    cell.dataset.pos = `${r},${c}`;
                    cell.onclick = () => handleAction(r, c);
                    gridEl.appendChild(cell);
                }
            }
        }

        function generateMines(safeRow, safeCol) {
            state.mines = [];
            let placed = 0;
            const safeRadius = Math.max(1, 2 - Math.floor(state.level / 15));

            while (placed < state.mineCount) {
                const r = Math.floor(Math.random() * state.rows);
                const c = Math.floor(Math.random() * state.cols);
                const dist = Math.max(Math.abs(r - safeRow), Math.abs(c - safeCol));
                const pos = `${r},${c}`;
                if (!state.mines.includes(pos) && dist > safeRadius) {
                    state.mines.push(pos);
                    placed++;
                }
            }
        }

        function handleAction(r, c) {
            if (state.gameOver) return;
            const pos = `${r},${c}`;

            if (state.isFlagMode) {
                if (state.revealed.has(pos)) return;
                const cell = document.querySelector(`[data-pos="${pos}"]`);
                if (state.flags.has(pos)) {
                    state.flags.delete(pos);
                    cell.textContent = '';
                } else if (state.flags.size < state.mineCount) {
                    state.flags.add(pos);
                    cell.textContent = 'üö©';
                    tg.HapticFeedback.impactOccurred('light');
                }
                updateUI();
                return;
            }

            if (state.flags.has(pos) || state.revealed.has(pos)) return;

            if (state.firstClick) {
                state.firstClick = false;
                generateMines(r, c);
            }

            if (state.mines.includes(pos)) {
                endGame(false);
                return;
            }

            reveal(r, c);
            if (state.revealed.size === (state.rows * state.cols) - state.mineCount) {
                endGame(true);
            }
        }

        function reveal(r, c) {
            const pos = `${r},${c}`;
            if (r < 0 || r >= state.rows || c < 0 || c >= state.cols || state.revealed.has(pos) || state.flags.has(pos)) return;

            state.revealed.add(pos);
            const cell = document.querySelector(`[data-pos="${pos}"]`);
            cell.className = 'cell cell-revealed';
            
            const count = countMines(r, c);
            if (count > 0) {
                cell.textContent = count;
                cell.classList.add(`num-${count}`);
            } else {
                for(let i=-1; i<=1; i++) {
                    for(let j=-1; j<=1; j++) {
                        reveal(r+i, c+j);
                    }
                }
            }
        }

        function countMines(r, c) {
            let count = 0;
            for(let i=-1; i<=1; i++) {
                for(let j=-1; j<=1; j++) {
                    if (state.mines.includes(`${r+i},${c+j}`)) count++;
                }
            }
            return count;
        }

        function endGame(win) {
            state.gameOver = true;
            const biome = BIOMES[(state.level - 1) % BIOMES.length];

            if (win) {
                state.balance += 100 + (state.level * 25);
                state.worldsCleared++;
                tg.HapticFeedback.notificationOccurred('success');

                showModal('‚ú®', 'SECTOR CLEAR', `–õ–æ–∫–∞—Ü–∏—è ${biome.name} –ø—Ä–æ–π–¥–µ–Ω–∞!`, '–í–ü–ï–†–ï–î', () => {
                    state.level++;
                    initGame();
                    document.getElementById('game-modal').classList.add('hidden');
                });
            } else {
                tg.HapticFeedback.notificationOccurred('error');
                state.mines.forEach(pos => {
                    const cell = document.querySelector(`[data-pos="${pos}"]`);
                    cell.className = 'cell cell-revealed cell-mine';
                    cell.textContent = biome.mine;
                });
                showModal('üíÄ', 'FAILED', '–í—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏ –ª–æ–≤—É—à–∫—É.', '–ü–û–í–¢–û–†', () => {
                    initGame();
                    document.getElementById('game-modal').classList.add('hidden');
                });
            }
        }

        function shareProgress() {
            const biome = BIOMES[(state.level - 1) % BIOMES.length];
            const name = tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";
            const text = `üéÆ ${name} –ø–µ—Ä–µ—à—ë–ª –Ω–∞ –ª–æ–∫–∞—Ü–∏—é ${biome.name} (–£—Ä–æ–≤–µ–Ω—å ${state.level}) –≤ Minesweeper Worlds!`;
            tg.switchInlineQuery(text);
        }

        function showModal(icon, title, text, btn, action) {
            document.getElementById('modal-icon').textContent = icon;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            const b = document.getElementById('modal-btn');
            b.textContent = btn;
            b.onclick = action;
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function updateUI() {
            document.getElementById('balance').textContent = state.balance.toLocaleString();
            document.getElementById('stat-coins').textContent = state.balance.toLocaleString();
            document.getElementById('stat-worlds').textContent = state.worldsCleared;
            
            const ranks = ["–ù–æ–≤–∏—á–æ–∫", "–°—Ç–∞–ª–∫–µ—Ä", "–ò–Ω–∂–µ–Ω–µ—Ä", "–°–∞–ø–µ—Ä", "–ü—Ä–∏–∑—Ä–∞–∫", "–õ–µ–≥–µ–Ω–¥–∞"];
            const rankIdx = Math.min(ranks.length - 1, Math.floor(state.level / 4));
            document.getElementById('user-status').textContent = ranks[rankIdx];
            document.getElementById('profile-status-badge').textContent = ranks[rankIdx];
      
