<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Minesweeper Worlds</title>
    <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Telegram WebApp SDK –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        :root {
            --tg-theme-bg-color: #0f172a;
            --tg-theme-button-color: #3b82f6;
            --tg-theme-button-text-color: #ffffff;
            --accent: #3b82f6;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: #ffffff;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
        }

        /* –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è GPU */
        .grid-container {
            will-change: transform;
            transform: translateZ(0);
        }

        .cell {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            cursor: pointer;
            user-select: none;
            border-radius: 8px;
            font-size: 1.1rem;
            transition: background-color 0.1s ease;
        }

        .cell-hidden {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.05);
        }

        .cell-revealed {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .cell-mine {
            background: #ef4444 !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        /* –¶–≤–µ—Ç–∞ —Ü–∏—Ñ—Ä (–Ω–∞—Ç–∏–≤–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –±—ã—Å—Ç—Ä–µ–µ –∫–∞—Ä—Ç–∏–Ω–æ–∫) */
        .num-1 { color: #60a5fa; } .num-2 { color: #34d399; } .num-3 { color: #f87171; }
        .num-4 { color: #a78bfa; } .num-5 { color: #fbbf24; } .num-6 { color: #22d3ee; }
        .num-7 { color: #f472b6; } .num-8 { color: #e5e7eb; }

        /* –ü–ª–∞–≤–∞—é—â–µ–µ –º–µ–Ω—é —Å —Ä–∞–∑–º—ã—Ç–∏–µ–º (Glassmorphism) */
        .nav-container {
            position: fixed;
            bottom: calc(20px + env(safe-area-inset-bottom));
            left: 20px;
            right: 20px;
            height: 64px;
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            display: flex;
            z-index: 1000;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.4;
            transition: 0.2s;
            border: none;
            background: none;
            color: white;
        }

        .nav-item.active {
            opacity: 1;
            color: var(--accent);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        /* –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —Å–ª–∞–±—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; }
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Header -->
    <header class="p-4 flex justify-between items-center bg-black/20 backdrop-blur-sm">
        <div id="user-info" class="flex items-center space-x-3">
            <div id="user-photo" class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold text-sm bg-cover border border-white/10">?</div>
            <div>
                <div id="user-name" class="text-sm font-bold truncate max-w-[100px]">Player</div>
                <div class="text-[9px] opacity-50 uppercase font-black" id="user-status">–ù–æ–≤–∏—á–æ–∫</div>
            </div>
        </div>
        <div class="text-right">
            <div class="text-[9px] opacity-40 uppercase font-black">–ö–æ–∏–Ω—ã</div>
            <div class="text-lg font-black text-yellow-500 tabular-nums"><span id="balance">0</span></div>
        </div>
    </header>

    <!-- Content Area -->
    <main class="flex-1 flex flex-col p-4 overflow-y-auto pb-32">
        <!-- Location Card -->
        <div id="loc-banner" class="mb-6 p-3 rounded-2xl text-center text-[10px] font-black uppercase tracking-widest border border-white/10 bg-white/5 shadow-xl transition-all">
            üå≤ –¢–ò–•–ò–ô –õ–ï–°
        </div>

        <!-- Board Wrapper -->
        <div class="flex-1 flex items-center justify-center">
            <div id="grid-container" class="p-2 rounded-3xl bg-black/20 border border-white/5 shadow-2xl grid-container">
                <div id="grid" class="grid gap-1.5">
                    <!-- JS Grid -->
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="mt-8 flex items-center justify-between px-4">
            <div class="text-center">
                <button id="flag-mode-btn" class="w-14 h-14 rounded-2xl bg-white/5 flex items-center justify-center text-xl border border-white/10 active:scale-90 transition-transform">
                    üö©
                </button>
                <div id="mine-count" class="mt-2 text-[8px] font-black opacity-40 uppercase">10 Left</div>
            </div>

            <button id="refresh-btn" class="w-10 h-10 rounded-full bg-white/5 flex items-center justify-center opacity-30">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            </button>

            <div class="text-center">
                <button onclick="shareProgress()" class="w-14 h-14 rounded-2xl bg-white/5 flex items-center justify-center text-xl border border-white/10 active:scale-90 transition-transform">
                    üì¢
                </button>
                <div class="mt-2 text-[8px] font-black opacity-40 uppercase">Share</div>
            </div>
        </div>
    </main>

    <!-- Bottom Nav -->
    <nav class="nav-container">
        <button onclick="switchTab('game')" id="tab-game" class="nav-item active">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/></svg>
            <span>–ú–∏—Ä—ã</span>
        </button>
        <button onclick="switchTab('profile')" id="tab-profile" class="nav-item">
            <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
            <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
    </nav>

    <!-- Views -->
    <div id="profile-view" class="fixed inset-0 z-[1001] bg-slate-950 hidden flex flex-col pt-12 px-6">
        <div class="flex justify-between items-center mb-10">
            <h2 class="text-2xl font-black italic uppercase tracking-tighter">My Stats</h2>
            <button onclick="switchTab('game')" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-xl">&times;</button>
        </div>
        
        <div class="bg-white/5 rounded-3xl p-8 border border-white/10 flex flex-col items-center">
            <div id="profile-avatar" class="w-24 h-24 rounded-full bg-gradient-to-tr from-blue-500 to-emerald-500 mb-6 flex items-center justify-center text-4xl shadow-2xl bg-cover border-4 border-white/10"></div>
            <div id="profile-name" class="text-2xl font-black mb-1">...</div>
            <div id="profile-status-badge" class="px-4 py-1 bg-blue-500 text-[10px] font-black uppercase rounded-full">–ù–æ–≤–∏—á–æ–∫</div>
        </div>

        <div class="grid grid-cols-2 gap-4 mt-8">
            <div class="bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="text-[9px] opacity-30 font-black uppercase mb-1">–í—Å–µ–≥–æ –º–æ–Ω–µ—Ç</div>
                <div id="stat-coins" class="text-xl font-black tabular-nums">0</div>
            </div>
            <div class="bg-white/5 p-5 rounded-2xl border border-white/5">
                <div class="text-[9px] opacity-30 font-black uppercase mb-1">–ü—Ä–æ–π–¥–µ–Ω–æ</div>
                <div id="stat-worlds" class="text-xl font-black tabular-nums">0</div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="game-modal" class="modal-overlay fixed inset-0 z-[2000] hidden flex items-center justify-center p-6">
        <div class="bg-slate-900 w-full max-w-xs rounded-[32px] p-8 text-center border border-white/10">
            <div id="modal-icon" class="text-7xl mb-4">üèÜ</div>
            <h2 id="modal-title" class="text-2xl font-black mb-1 uppercase">Win</h2>
            <p id="modal-text" class="text-slate-400 text-xs mb-8 font-bold">–°–µ–∫—Ç–æ—Ä –∑–∞—á–∏—â–µ–Ω!</p>
            <button id="modal-btn" class="w-full py-4 rounded-xl font-black text-xs uppercase tracking-widest transition-all" style="background: var(--accent); color: white;">
                –î–∞–ª–µ–µ
            </button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const BIOMES = [
            { name: "–¢–∏—Ö–∏–π –õ–µ—Å", emoji: "üå≤", mine: "üçÑ", bg: "#064e3b", accent: "#10b981" },
            { name: "–ó–æ–ª–æ—Ç–∞—è –ü—É—Å—Ç—ã–Ω—è", emoji: "üèúÔ∏è", mine: "ü¶Ç", bg: "#422006", accent: "#fbbf24" },
            { name: "–õ–µ–¥—è–Ω–æ–π –ì—Ä–æ—Ç", emoji: "‚ùÑÔ∏è", mine: "üßä", bg: "#0c4a6e", accent: "#38bdf8" },
            { name: "–ó–∞–±—ã—Ç–∞—è –®–∞—Ö—Ç–∞", emoji: "‚öíÔ∏è", mine: "üß®", bg: "#451a03", accent: "#f97316" },
            { name: "–ö—Ä–æ–≤–∞–≤—ã–π –†–∏—Ñ—Ç", emoji: "üåò", mine: "üåã", bg: "#450a0a", accent: "#ef4444" },
            { name: "–ù–µ–æ–Ω–æ–≤—ã–π –°–∏—Ç–∏", emoji: "üåÉ", mine: "üëæ", bg: "#2e1065", accent: "#a855f7" },
            { name: "–ú–µ—Ä—Ç–≤—ã–π –ö–æ—Å–º–æ—Å", emoji: "ü™ê", mine: "‚òÑÔ∏è", bg: "#111827", accent: "#6366f1" },
            { name: "–Ø–¥—Ä–æ –ü–ª–∞–Ω–µ—Ç—ã", emoji: "‚ò¢Ô∏è", mine: "üî•", bg: "#1e1b4b", accent: "#f43f5e" }
        ];

        let state = {
            level: 1, balance: 0, worldsCleared: 0,
            rows: 7, cols: 7, mineCount: 8, mines: [],
            revealed: new Set(), flags: new Set(),
            firstClick: true, gameOver: false, isFlagMode: false
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function setupApp() {
            tg.expand();
            const user = tg.initDataUnsafe?.user;
            if (user) {
                document.getElementById('user-name').textContent = user.first_name;
                document.getElementById('profile-name').textContent = user.first_name;
                if (user.photo_url) {
                    const avatarEls = [document.getElementById('user-photo'), document.getElementById('profile-avatar')];
                    avatarEls.forEach(el => {
                        el.style.backgroundImage = `url(${user.photo_url})`;
                        el.textContent = '';
                    });
                }
            }
            document.documentElement.style.setProperty('--accent', tg.themeParams.button_color || '#3b82f6');
            initGame();
        }

        function initGame() {
            state.gameOver = false;
            state.firstClick = true;
            state.revealed.clear();
            state.flags.clear();
            
            state.rows = Math.min(10, 6 + Math.floor(state.level / 5));
            state.cols = state.rows;
            const density = 0.16 + (state.level * 0.008);
            state.mineCount = Math.floor(state.rows * state.cols * Math.min(0.25, density));

            const biome = BIOMES[(state.level - 1) % BIOMES.length];
            document.body.style.backgroundColor = biome.bg;
            
            const banner = document.getElementById('loc-banner');
            banner.innerHTML = `${biome.emoji} ${biome.name}`;
            banner.style.color = biome.accent;
            banner.style.borderColor = `${biome.accent}33`;

            renderGrid();
            updateUI();
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${state.cols}, 1fr)`;
            
            const fragment = document.createDocumentFragment();
            for (let r = 0; r < state.rows; r++) {
                for (let c = 0; c < state.cols; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell cell-hidden';
                    cell.dataset.pos = `${r},${c}`;
                    cell.onclick = () => handleCellClick(r, c);
                    fragment.appendChild(cell);
                }
            }
            grid.appendChild(fragment);
        }

        function handleCellClick(r, c) {
            if (state.gameOver) return;
            const pos = `${r},${c}`;

            if (state.isFlagMode) {
                if (state.revealed.has(pos)) return;
                const cell = document.querySelector(`[data-pos="${pos}"]`);
                if (state.flags.has(pos)) {
                    state.flags.delete(pos);
                    cell.textContent = '';
                } else if (state.flags.size < state.mineCount) {
                    state.flags.add(pos);
                    cell.textContent = 'üö©';
                    tg.HapticFeedback.impactOccurred('light');
                }
                updateUI();
                return;
            }

            if (state.flags.has(pos) || state.revealed.has(pos)) return;

            if (state.firstClick) {
                state.firstClick = false;
                generateMines(r, c);
            }

            if (state.mines.includes(pos)) {
                endGame(false);
                return;
            }

            revealCells(r, c);
            if (state.revealed.size === (state.rows * state.cols) - state.mineCount) {
                endGame(true);
            }
        }

        function generateMines(sr, sc) {
            state.mines = [];
            const safeRadius = state.level > 10 ? 1 : 2;
            while (state.mines.length < state.mineCount) {
                const r = Math.floor(Math.random() * state.rows);
                const c = Math.floor(Math.random() * state.cols);
                const dist = Math.max(Math.abs(r - sr), Math.abs(c - sc));
                const pos = `${r},${c}`;
                if (!state.mines.includes(pos) && dist > safeRadius) state.mines.push(pos);
            }
        }

        function revealCells(r, c) {
            const pos = `${r},${c}`;
            if (r < 0 || r >= state.rows || c < 0 || c >= state.cols || state.revealed.has(pos) || state.flags.has(pos)) return;

            state.revealed.add(pos);
            const cell = document.querySelector(`[data-pos="${pos}"]`);
            cell.className = 'cell cell-revealed';
            
            let mines = 0;
            for(let i=-1; i<=1; i++) {
                for(let j=-1; j<=1; j++) {
                    if (state.mines.includes(`${r+i},${c+j}`)) mines++;
                }
            }

            if (mines > 0) {
                cell.textContent = mines;
                cell.classList.add(`num-${mines}`);
            } else {
                for(let i=-1; i<=1; i++) {
                    for(let j=-1; j<=1; j++) revealCells(r+i, c+j);
                }
            }
        }

        function endGame(win) {
            state.gameOver = true;
            const biome = BIOMES[(state.level - 1) % BIOMES.length];
            if (win) {
                state.balance += 100 + (state.level * 25);
                state.worldsCleared++;
                tg.HapticFeedback.notificationOccurred('success');
                showModal('‚ú®', 'SECTOR CLEAR', `–°–µ–∫—Ç–æ—Ä ${biome.name} –∑–∞—á–∏—â–µ–Ω!`, '–í–ü–ï–†–ï–î', () => {
                    state.level++; initGame();
                    document.getElementById('game-modal').classList.add('hidden');
                });
            } else {
                tg.HapticFeedback.notificationOccurred('error');
                state.mines.forEach(m => {
                    const el = document.querySelector(`[data-pos="${m}"]`);
                    el.className = 'cell cell-revealed cell-mine';
                    el.textContent = biome.mine;
                });
                showModal('üíÄ', 'SYSTEM OVERLOAD', '–í—ã –Ω–∞—Å—Ç—É–ø–∏–ª–∏ –Ω–∞ –ª–æ–≤—É—à–∫—É.', 'RETRY', () => {
                    initGame();
                    document.getElementById('game-modal').classList.add('hidden');
                });
            }
        }

        function showModal(icon, title, text, btn, action) {
            document.getElementById('modal-icon').textContent = icon;
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text;
            const b = document.getElementById('modal-btn');
            b.textContent = btn;
            b.onclick = action;
            document.getElementById('game-modal').classList.remove('hidden');
        }

        function updateUI() {
            document.getElementById('balance').textContent = state.balance.toLocaleString();
            document.getElementById('stat-coins').textContent = state.balance.toLocaleString();
            document.getElementById('stat-worlds').textContent = state.worldsCleared;
            document.getElementById('mine-count').textContent = `${state.mineCount - state.flags.size} Left`;
            
            const ranks = ["–ù–æ–≤–∏—á–æ–∫", "–°—Ç–∞–ª–∫–µ—Ä", "–ò–Ω–∂–µ–Ω–µ—Ä", "–°–∞–ø–µ—Ä", "–ü—Ä–∏–∑—Ä–∞–∫", "–õ–µ–≥–µ–Ω–¥–∞"];
            const rank = ranks[Math.min(ranks.length - 1, Math.floor(state.level / 5))];
            document.getElementById('user-status').textContent = rank;
            document.getElementById('profile-status-badge').textContent = rank;
        }

        function switchTab(tab) {
            const p = document.getElementById('profile-view');
            const gt = document.getElementById('tab-game');
            const pt = document.getElementById('tab-profile');
            if (tab === 'profile') {
                p.classList.remove('hidden');
                pt.classList.add('active');
                gt.classList.remove('active');
            } else {
                p.classList.add('hidden');
                gt.classList.add('active');
                pt.classList.remove('active');
            }
        }

        function shareProgress() {
            const b = BIOMES[(state.level - 1) % BIOMES.length];
            const name = tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫";
            tg.switchInlineQuery(`üéÆ ${name} –ø–µ—Ä–µ—à–µ–ª –≤ –ª–æ–∫–∞—Ü–∏—é ${b.name}! –ü–æ–ø—Ä–æ–±—É–π –∏ —Ç—ã!`);
        }

        document.getElementById('flag-mode-btn').onclick = function() {
            state.isFlagMode = !state.i
